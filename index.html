<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>树穴老邓之死</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .stat-bar {
            height: 20px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }
        .stat-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="text-white">
    <div id="startModal" class="modal active">
        <div class="glass rounded-2xl p-8 max-w-2xl w-full mx-4">
            <h1 class="text-4xl font-bold text-center mb-8">树穴老邓之死</h1>
            <h2 class="text-2xl font-semibold mb-4"><pre>    巨浪同志的树穴老邓被滚回了精神病院，导致了巨浪的初中树穴牢尸不见了，需要长达一坤年的自学。</pre></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h2 class="text-2xl font-semibold mb-4">知识点分配 (共30点)</h2>
                    <div id="knowledgePoints" class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label for="numberTheory" class="font-medium">数论</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustKnowledge('numberTheory', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="numberTheory" value="5" min="0" max="30" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustKnowledge('numberTheory', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="algebra" class="font-medium">代数</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustKnowledge('algebra', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="algebra" value="5" min="0" max="30" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustKnowledge('algebra', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="geometry" class="font-medium">几何</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustKnowledge('geometry', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="geometry" value="5" min="0" max="30" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustKnowledge('geometry', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="operation" class="font-medium">操作</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustKnowledge('operation', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="operation" value="5" min="0" max="30" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustKnowledge('operation', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="reasoning" class="font-medium">推理</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustKnowledge('reasoning', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="reasoning" value="5" min="0" max="30" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustKnowledge('reasoning', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="counting" class="font-medium">计数</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustKnowledge('counting', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="counting" value="5" min="0" max="30" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustKnowledge('counting', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                    </div>
                    <p class="text-center mt-4" id="knowledgeTotal">剩余: 0</p>
                </div>
                <div>
                    <h2 class="text-2xl font-semibold mb-4">天赋点分配 (共15点)</h2>
                    <div id="talentPoints" class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label for="carefulness" class="font-medium">细心</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustTalent('carefulness', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="carefulness" value="3" min="0" max="15" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustTalent('carefulness', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="mentality" class="font-medium">心态</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustTalent('mentality', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="mentality" value="3" min="0" max="15" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustTalent('mentality', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="speed" class="font-medium">手速</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustTalent('speed', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="speed" value="3" min="0" max="15" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustTalent('speed', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="creativity" class="font-medium">创造力</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustTalent('creativity', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="creativity" value="3" min="0" max="15" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustTalent('creativity', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label for="thinking" class="font-medium">思维</label>
                            <div class="flex items-center gap-2">
                                <button onclick="adjustTalent('thinking', -1)" class="w-8 h-8 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center">-</button>
                                <input type="number" id="thinking" value="3" min="0" max="15" class="w-12 text-center rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <button onclick="adjustTalent('thinking', 1)" class="w-8 h-8 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                    </div>
                    <p class="text-center mt-4" id="talentTotal">剩余: 0</p>
                </div>
            </div>
            <button onclick="startGame()" class="w-full mt-8 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 font-bold text-lg btn">开始游戏</button>
        </div>
    </div>

    <div id="gameModal" class="modal">
        <div class="glass rounded-2xl p-8 max-w-6xl w-full mx-4 h-[90vh] flex flex-col">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-semibold mb-3">知识点</h3>
                    <div class="space-y-2">
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>数论</span>
                                <span id="ntValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="ntBar" class="stat-fill bg-blue-400" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>代数</span>
                                <span id="algValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="algBar" class="stat-fill bg-green-400" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>几何</span>
                                <span id="geoValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="geoBar" class="stat-fill bg-yellow-400" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>操作</span>
                                <span id="opValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="opBar" class="stat-fill bg-red-400" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>推理</span>
                                <span id="reaValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="reaBar" class="stat-fill bg-purple-400" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>计数</span>
                                <span id="couValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="couBar" class="stat-fill bg-pink-400" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-semibold mb-3">天赋</h3>
                    <div class="space-y-2">
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>细心</span>
                                <span id="careValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="careBar" class="stat-fill bg-indigo-400" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>心态</span>
                                <span id="menValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="menBar" class="stat-fill bg-teal-400" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>手速</span>
                                <span id="speedValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="speedBar" class="stat-fill bg-orange-400" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>创造力</span>
                                <span id="creaValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="creaBar" class="stat-fill bg-lime-400" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>思维</span>
                                <span id="thinkValue">0</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="thinkBar" class="stat-fill bg-cyan-400" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="glass rounded-xl p-4">
                    <h3 class="text-xl font-semibold mb-3">状态</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm">
                                <span>压力</span>
                                <span id="pressureValue">0/100</span>
                            </div>
                            <div class="stat-bar mt-1">
                                <div id="pressureBar" class="stat-fill bg-red-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold" id="roundCounter">第 1 回合</p>
                            <p class="text-sm mt-2">所有操作消耗 1 回合</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 flex-grow overflow-y-auto">
                <button onclick="showActionModal('train')" class="glass rounded-xl p-6 flex flex-col items-center justify-center h-full btn">
                    <i data-lucide="book-open" class="w-12 h-12 mb-4"></i>
                    <h3 class="text-xl font-bold">训练</h3>
                    <p class="text-sm text-center mt-2">选择一个知识点进行针对性训练</p>
                </button>
                <button onclick="showActionModal('practice')" class="glass rounded-xl p-6 flex flex-col items-center justify-center h-full btn">
                    <i data-lucide="pen-tool" class="w-12 h-12 mb-4"></i>
                    <h3 class="text-xl font-bold">刷题</h3>
                    <p class="text-sm text-center mt-2">全面提升所有知识点</p>
                </button>
                <button onclick="showActionModal('rest')" class="glass rounded-xl p-6 flex flex-col items-center justify-center h-full btn">
                    <i data-lucide="coffee" class="w-12 h-12 mb-4"></i>
                    <h3 class="text-xl font-bold">摸鱼</h3>
                    <p class="text-sm text-center mt-2">缓解压力，提升心态</p>
                </button>
                <button onclick="showActionModal('evil')" class="glass rounded-xl p-6 flex flex-col items-center justify-center h-full btn">
                    <i data-lucide="zap" class="w-12 h-12 mb-4"></i>
                    <h3 class="text-xl font-bold">邪修</h3>
                    <p class="text-sm text-center mt-2">快速提升能力，但有风险</p>
                </button>
                <button onclick="showActionModal('research')" class="glass rounded-xl p-6 flex flex-col items-center justify-center h-full btn">
                    <i data-lucide="flask-conical" class="w-12 h-12 mb-4"></i>
                    <h3 class="text-xl font-bold">钻研</h3>
                    <p class="text-sm text-center mt-2">深入研究一个知识点</p>
                </button>
                <button onclick="showActionModal('exercise')" class="glass rounded-xl p-6 flex flex-col items-center justify-center h-full btn">
                    <i data-lucide="dumbbell" class="w-12 h-12 mb-4"></i>
                    <h3 class="text-xl font-bold">实践</h3>
                    <p class="text-sm text-center mt-2">提升多项天赋，缓解压力</p>
                </button>
                <button onclick="showActionModal('exam')" class="glass rounded-xl p-6 flex flex-col items-center justify-center h-full btn col-span-1 md:col-span-2 lg:col-span-3">
                    <i data-lucide="graduation-cap" class="w-12 h-12 mb-4"></i>
                    <h3 class="text-xl font-bold">考试</h3>
                    <p class="text-sm text-center mt-2">检验你的学习成果</p>
                </button>
            </div>
        </div>
    </div>

    <div id="actionModal" class="modal">
        <div class="glass rounded-2xl p-8 max-w-lg w-full mx-4">
            <h2 id="actionTitle" class="text-3xl font-bold text-center mb-6">行动</h2>
            <div id="actionContent" class="space-y-6">
                <!-- 动态内容 -->
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeActionModal()" class="flex-1 py-3 rounded-xl bg-gray-500 hover:bg-gray-600 font-bold btn">取消</button>
                <button id="confirmAction" onclick="confirmAction()" class="flex-1 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 font-bold btn">确认</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="glass rounded-2xl p-8 max-w-lg w-full mx-4">
            <h2 id="resultTitle" class="text-3xl font-bold text-center mb-6">结果</h2>
            <div id="resultContent" class="space-y-4">
                <!-- 动态内容 -->
            </div>
            <button onclick="closeResultModal()" class="w-full mt-8 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 font-bold btn">继续</button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let gameState = {
            knowledge: {
                numberTheory: 0,
                algebra: 0,
                geometry: 0,
                operation: 0,
                reasoning: 0,
                counting: 0
            },
            talents: {
                carefulness: 0,
                mentality: 0,
                speed: 0,
                creativity: 0,
                thinking: 0
            },
            pressure: 0,
            round: 1,
            currentAction: null
        };

        let knowledgePointsRemaining = 30;
        let talentPointsRemaining = 15;

        // 向上取整工具函数
        function ceilAllValues() {
            // 知识点向上取整
            Object.keys(gameState.knowledge).forEach(key => {
                gameState.knowledge[key] = Math.ceil(Math.min(100, gameState.knowledge[key]));
            });
            // 天赋向上取整
            Object.keys(gameState.talents).forEach(key => {
                gameState.talents[key] = Math.ceil(Math.min(20, gameState.talents[key]));
            });
            // 压力向上取整
            gameState.pressure = Math.ceil(Math.min(100, Math.max(0, gameState.pressure)));
        }

        function updatePointCounters() {
            const knowledgeTotal = Object.values({
                numberTheory: parseInt(document.getElementById('numberTheory').value) || 0,
                algebra: parseInt(document.getElementById('algebra').value) || 0,
                geometry: parseInt(document.getElementById('geometry').value) || 0,
                operation: parseInt(document.getElementById('operation').value) || 0,
                reasoning: parseInt(document.getElementById('reasoning').value) || 0,
                counting: parseInt(document.getElementById('counting').value) || 0
            }).reduce((a, b) => a + b, 0);
            knowledgePointsRemaining = 30 - knowledgeTotal;
            document.getElementById('knowledgeTotal').textContent = `剩余: ${knowledgePointsRemaining}`;

            const talentTotal = Object.values({
                carefulness: parseInt(document.getElementById('carefulness').value) || 0,
                mentality: parseInt(document.getElementById('mentality').value) || 0,
                speed: parseInt(document.getElementById('speed').value) || 0,
                creativity: parseInt(document.getElementById('creativity').value) || 0,
                thinking: parseInt(document.getElementById('thinking').value) || 0
            }).reduce((a, b) => a + b, 0);
            talentPointsRemaining = 15 - talentTotal;
            document.getElementById('talentTotal').textContent = `剩余: ${talentPointsRemaining}`;
        }

        function adjustKnowledge(type, delta) {
            const input = document.getElementById(type);
            let value = parseInt(input.value) || 0;
            value = Math.max(0, Math.min(30, value + delta));
            input.value = value;
            updatePointCounters();
        }

        function adjustTalent(type, delta) {
            const input = document.getElementById(type);
            let value = parseInt(input.value) || 0;
            value = Math.max(0, Math.min(15, value + delta));
            input.value = value;
            updatePointCounters();
        }

        function startGame() {
            if (knowledgePointsRemaining !== 0 || talentPointsRemaining !== 0) {
                alert('请分配所有点数！');
                return;
            }

            gameState.knowledge = {
                numberTheory: parseInt(document.getElementById('numberTheory').value),
                algebra: parseInt(document.getElementById('algebra').value),
                geometry: parseInt(document.getElementById('geometry').value),
                operation: parseInt(document.getElementById('operation').value),
                reasoning: parseInt(document.getElementById('reasoning').value),
                counting: parseInt(document.getElementById('counting').value)
            };

            gameState.talents = {
                carefulness: parseInt(document.getElementById('carefulness').value),
                mentality: parseInt(document.getElementById('mentality').value),
                speed: parseInt(document.getElementById('speed').value),
                creativity: parseInt(document.getElementById('creativity').value),
                thinking: parseInt(document.getElementById('thinking').value)
            };

            document.getElementById('startModal').classList.remove('active');
            document.getElementById('gameModal').classList.add('active');
            updateDisplay();
        }

        function updateDisplay() {
            // 知识点显示（取整）
            document.getElementById('ntValue').textContent = Math.ceil(gameState.knowledge.numberTheory);
            document.getElementById('ntBar').style.width = `${Math.min(100, Math.ceil(gameState.knowledge.numberTheory))}%`;
            document.getElementById('algValue').textContent = Math.ceil(gameState.knowledge.algebra);
            document.getElementById('algBar').style.width = `${Math.min(100, Math.ceil(gameState.knowledge.algebra))}%`;
            document.getElementById('geoValue').textContent = Math.ceil(gameState.knowledge.geometry);
            document.getElementById('geoBar').style.width = `${Math.min(100, Math.ceil(gameState.knowledge.geometry))}%`;
            document.getElementById('opValue').textContent = Math.ceil(gameState.knowledge.operation);
            document.getElementById('opBar').style.width = `${Math.min(100, Math.ceil(gameState.knowledge.operation))}%`;
            document.getElementById('reaValue').textContent = Math.ceil(gameState.knowledge.reasoning);
            document.getElementById('reaBar').style.width = `${Math.min(100, Math.ceil(gameState.knowledge.reasoning))}%`;
            document.getElementById('couValue').textContent = Math.ceil(gameState.knowledge.counting);
            document.getElementById('couBar').style.width = `${Math.min(100, Math.ceil(gameState.knowledge.counting))}%`;

            // 天赋显示（取整）
            document.getElementById('careValue').textContent = Math.ceil(gameState.talents.carefulness);
            document.getElementById('careBar').style.width = `${(Math.ceil(gameState.talents.carefulness) / 20) * 100}%`;
            document.getElementById('menValue').textContent = Math.ceil(gameState.talents.mentality);
            document.getElementById('menBar').style.width = `${(Math.ceil(gameState.talents.mentality) / 20) * 100}%`;
            document.getElementById('speedValue').textContent = Math.ceil(gameState.talents.speed);
            document.getElementById('speedBar').style.width = `${(Math.ceil(gameState.talents.speed) / 20) * 100}%`;
            document.getElementById('creaValue').textContent = Math.ceil(gameState.talents.creativity);
            document.getElementById('creaBar').style.width = `${(Math.ceil(gameState.talents.creativity) / 20) * 100}%`;
            document.getElementById('thinkValue').textContent = Math.ceil(gameState.talents.thinking);
            document.getElementById('thinkBar').style.width = `${(Math.ceil(gameState.talents.thinking) / 20) * 100}%`;

            // 压力显示（取整）
            document.getElementById('pressureValue').textContent = `${Math.ceil(gameState.pressure)}/100`;
            document.getElementById('pressureBar').style.width = `${Math.ceil(gameState.pressure)}%`;

            // 更新回合
            document.getElementById('roundCounter').textContent = `第 ${gameState.round} 回合`;
        }

        function showActionModal(action) {
            gameState.currentAction = action;
            const modal = document.getElementById('actionModal');
            const title = document.getElementById('actionTitle');
            const content = document.getElementById('actionContent');

            switch (action) {
                case 'train':
                    title.textContent = '训练';
                    // 实时计算压力增加量（基于当前心态和训练强度）
                    const currentMentality = gameState.talents.mentality;
                    content.innerHTML = `
                        <div>
                            <label class="block mb-2 font-medium">选择知识点</label>
                            <select id="trainKnowledge" class="w-full p-2 rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <option value="numberTheory">数论</option>
                                <option value="algebra">代数</option>
                                <option value="geometry">几何</option>
                                <option value="operation">操作</option>
                                <option value="reasoning">推理</option>
                                <option value="counting">计数</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-2 font-medium">训练强度 (1-10)</label>
                            <input type="range" id="trainIntensity" min="1" max="10" value="5" class="w-full">
                            <div class="flex justify-between text-sm">
                                <span>1</span>
                                <span id="intensityValue">5</span>
                                <span>10</span>
                            </div>
                        </div>
                        <div class="mt-4 text-center text-yellow-300">
                            <p>压力增加量: 强度 × (20 - 当前心态)（当前心态${currentMentality}）</p>
                            <p>知识点效果系数: 0.0005 | 思维效果系数: 0.05 | 消耗 1 回合</p>
                        </div>
                    `;
                    document.getElementById('trainIntensity').addEventListener('input', (e) => {
                        document.getElementById('intensityValue').textContent = e.target.value;
                    });
                    break;
                case 'practice':
                    title.textContent = '刷题';
                    content.innerHTML = `<p class="text-center">所有知识点提升 ${Math.ceil(gameState.talents.thinking)}%，思维+1，压力+5<br><span class="text-yellow-300">消耗 1 回合</span></p>`;
                    break;
                case 'rest':
                    title.textContent = '摸鱼';
                    content.innerHTML = `<p class="text-center">压力 -${Math.ceil(gameState.talents.mentality * 3)}，心态 +2<br><span class="text-yellow-300">消耗 1 回合</span></p>`;
                    break;
                case 'evil':
                    title.textContent = '邪修';
                    const failRate = Math.max(0, 100 - 3 * gameState.talents.thinking);
                    content.innerHTML = `<p class="text-center">思维 +5，随机知识点 +7，创造力 +2<br><span class="text-yellow-300">失效概率: ${failRate}% | 消耗 1 回合</span></p>`;
                    break;
                case 'research':
                    title.textContent = '钻研';
                    content.innerHTML = `
                        <div>
                            <label class="block mb-2 font-medium">选择知识点</label>
                            <select id="researchKnowledge" class="w-full p-2 rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400">
                                <option value="numberTheory">数论</option>
                                <option value="algebra">代数</option>
                                <option value="geometry">几何</option>
                                <option value="operation">操作</option>
                                <option value="reasoning">推理</option>
                                <option value="counting">计数</option>
                            </select>
                        </div>
                        <p class="text-center mt-4">压力 +20，该知识点 +8<br><span class="text-yellow-300">消耗 1 回合</span></p>
                    `;
                    break;
                case 'exercise':
                    title.textContent = '实践';
                    content.innerHTML = `<p class="text-center">手速 +1，细心 +1，创造力 +2，压力 -8<br><span class="text-yellow-300">消耗 1 回合</span></p>`;
                    break;
                case 'exam':
                    title.textContent = '考试';
                    content.innerHTML = `<p class="text-center">检验你的学习成果！<br><span class="text-yellow-300">消耗 1 回合</span></p>`;
                    break;
            }

            modal.classList.add('active');
        }

        function closeActionModal() {
            document.getElementById('actionModal').classList.remove('active');
        }

        function confirmAction() {
            let result = '';
            switch (gameState.currentAction) {
                case 'train':
                    const knowledge = document.getElementById('trainKnowledge').value;
                    const z = parseInt(document.getElementById('trainIntensity').value); // 训练强度z
                    const x = gameState.pressure; // 当前压力x
                    const k = gameState.talents.thinking; // 当前思维k
                    const y = gameState.knowledge[knowledge]; // 当前知识点分值y
                    const mentality = gameState.talents.mentality; // 当前心态
                    
                    // 严格按照新公式计算
                    // 知识点y新值 = (100-abs(50-x))*z*(5+y/10)*k*0.0005 + y
                    const newY = (100 - Math.abs(50 - x)) * z * (5 + y / 10) * k * 0.0005 + y;
                    // 思维k新值 = k + (50-abs(40-x-z*10))*0.05
                    const newK = k + (50 - Math.abs(40 - x - z * 10)) * 0.05;
                    // 压力x新值 = x + z*(20-当前心态)
                    const newX = x + z * (20 - mentality);
                    
                    // 更新数值
                    gameState.knowledge[knowledge] = newY;
                    gameState.talents.thinking = newK;
                    gameState.pressure = newX;
                    
                    // 所有数值向上取整并限制上限
                    ceilAllValues();
                    
                    // 构建结果提示
                    result = `训练完成！<br>
                             ${getKnowledgeName(knowledge)}: ${Math.ceil(y)} → ${gameState.knowledge[knowledge]}<br>
                             思维: ${Math.ceil(k)} → ${gameState.talents.thinking}<br>
                             压力: ${Math.ceil(x)} → ${gameState.pressure} (增加${Math.ceil(z * (20 - mentality))})<br>
                             <span class="text-yellow-300">知识点系数:0.0005 | 思维系数:0.05 | 消耗 1 回合</span>`;
                    break;
                case 'practice':
                    const boost = gameState.talents.thinking / 100;
                    const oldThinking = gameState.talents.thinking;
                    Object.keys(gameState.knowledge).forEach(key => {
                        gameState.knowledge[key] = gameState.knowledge[key] * (1 + boost);
                    });
                    gameState.talents.thinking += 1;
                    gameState.pressure += 5;
                    // 所有数值向上取整
                    ceilAllValues();
                    result = `刷题完成！<br>
                             所有知识点提升 ${Math.ceil(oldThinking)}%<br>
                             思维: ${Math.ceil(oldThinking)} → ${gameState.talents.thinking}<br>
                             压力: ${Math.ceil(gameState.pressure - 5)} → ${gameState.pressure}<br>
                             <span class="text-yellow-300">消耗 1 回合</span>`;
                    break;
                case 'rest':
                    const reduce = gameState.talents.mentality * 3;
                    const oldPressure = gameState.pressure;
                    const oldMentality = gameState.talents.mentality;
                    gameState.pressure -= reduce;
                    gameState.talents.mentality += 2;
                    // 所有数值向上取整
                    ceilAllValues();
                    result = `摸鱼愉快！<br>
                             压力: ${Math.ceil(oldPressure)} → ${gameState.pressure}<br>
                             心态: ${Math.ceil(oldMentality)} → ${gameState.talents.mentality}<br>
                             <span class="text-yellow-300">消耗 1 回合</span>`;
                    break;
                case 'evil':
                    // 邪修失效概率固定为 (100 - 3*思维)%
                    const failProbability = Math.max(0, 100 - 3 * gameState.talents.thinking);
                    const isFailed = Math.random() * 100 < failProbability;
                    
                    if (isFailed) {
                        result = `邪修失败！<br>
                                 本次邪修没有带来任何提升<br>
                                 失效概率: ${failProbability}%<br>
                                 <span class="text-yellow-300">消耗 1 回合</span>`;
                    } else {
                        const randomKnowledge = Object.keys(gameState.knowledge)[Math.floor(Math.random() * 6)];
                        const oldKnowledge = gameState.knowledge[randomKnowledge];
                        const oldThinking = gameState.talents.thinking;
                        const oldCreativity = gameState.talents.creativity;
                        
                        gameState.knowledge[randomKnowledge] += 7;
                        gameState.talents.thinking += 5;
                        gameState.talents.creativity += 2;
                        // 所有数值向上取整
                        ceilAllValues();
                        
                        result = `邪修成功！<br>
                                 ${getKnowledgeName(randomKnowledge)}: ${Math.ceil(oldKnowledge)} → ${gameState.knowledge[randomKnowledge]}<br>
                                 思维: ${Math.ceil(oldThinking)} → ${gameState.talents.thinking}<br>
                                 创造力: ${Math.ceil(oldCreativity)} → ${gameState.talents.creativity}<br>
                                 <span class="text-yellow-300">消耗 1 回合</span>`;
                    }
                    break;
                case 'research':
                    const researchKnowledge = document.getElementById('researchKnowledge').value;
                    const oldResearchValue = gameState.knowledge[researchKnowledge];
                    const oldResearchPressure = gameState.pressure;
                    gameState.knowledge[researchKnowledge] += 8;
                    gameState.pressure += 20;
                    // 所有数值向上取整
                    ceilAllValues();
                    result = `钻研完成！<br>
                             ${getKnowledgeName(researchKnowledge)}: ${Math.ceil(oldResearchValue)} → ${gameState.knowledge[researchKnowledge]}<br>
                             压力: ${Math.ceil(oldResearchPressure)} → ${gameState.pressure}<br>
                             <span class="text-yellow-300">消耗 1 回合</span>`;
                    break;
                case 'exercise':
                    const oldExercisePressure = gameState.pressure;
                    const oldSpeed = gameState.talents.speed;
                    const oldCare = gameState.talents.carefulness;
                    const oldCrea = gameState.talents.creativity;
                    
                    gameState.talents.speed += 1;
                    gameState.talents.carefulness += 1;
                    gameState.talents.creativity += 2;
                    gameState.pressure -= 8;
                    // 所有数值向上取整
                    ceilAllValues();
                    
                    result = `实践完成！<br>
                             手速: ${Math.ceil(oldSpeed)} → ${gameState.talents.speed}<br>
                             细心: ${Math.ceil(oldCare)} → ${gameState.talents.carefulness}<br>
                             创造力: ${Math.ceil(oldCrea)} → ${gameState.talents.creativity}<br>
                             压力: ${Math.ceil(oldExercisePressure)} → ${gameState.pressure}<br>
                             <span class="text-yellow-300">消耗 1 回合</span>`;
                    break;
                case 'exam':
                    // 生成0-8之间的随机权重，确保总和为20且无负数
                    let weights = [];
                    let total = 0;
                    for (let i = 0; i < 5; i++) {
                        const max = Math.min(8, 20 - total);
                        const weight = Math.floor(Math.random() * (max + 1));
                        weights.push(weight);
                        total += weight;
                    }
                    weights.push(20 - total);
                    const [a, b, c, d, e, f] = weights;
                    
                    result = `考试完成！<br><br>
                             知识点权重：<br>
                             数论: ${a} | 代数: ${b} | 几何: ${c}<br>
                             操作: ${d} | 推理: ${e} | 计数: ${f}<br><br>
                             选择一个知识点提升 20%<br>
                             <span class="text-yellow-300">消耗 1 回合</span>`;
                    
                    // 显示选择界面
                    const modal = document.getElementById('resultModal');
                    const content = document.getElementById('resultContent');
                    content.innerHTML = `
                        <p class="text-2xl font-bold text-center mb-4">${result}</p>
                        <select id="boostKnowledge" class="w-full p-2 rounded bg-white/20 border-none focus:ring-2 focus:ring-blue-400 mt-4">
                            <option value="numberTheory">数论</option>
                            <option value="algebra">代数</option>
                            <option value="geometry">几何</option>
                            <option value="operation">操作</option>
                            <option value="reasoning">推理</option>
                            <option value="counting">计数</option>
                        </select>
                    `;
                    const button = modal.querySelector('button');
                    button.textContent = '确认提升';
                    button.onclick = () => {
                        const selected = document.getElementById('boostKnowledge').value;
                        const oldValue = gameState.knowledge[selected];
                        const oldPressure = gameState.pressure;
                        
                        gameState.knowledge[selected] *= 1.2;
                        gameState.pressure = gameState.pressure * 1.2 + 20;
                        // 所有数值向上取整
                        ceilAllValues();
                        
                        content.innerHTML = `<p>提升完成！<br>
                                            ${getKnowledgeName(selected)}: ${Math.ceil(oldValue)} → ${gameState.knowledge[selected]}<br>
                                            压力: ${Math.ceil((oldPressure * 1.2 + 20 - 20) / 1.2)} → ${gameState.pressure}<br>
                                            <span class="text-yellow-300">消耗 1 回合</span></p>`;
                        button.textContent = '继续';
                        button.onclick = closeResultModal;
                        updateDisplay();
                    };
                    modal.classList.add('active');
                    break;
            }

            // 非考试操作直接显示结果
            if (gameState.currentAction !== 'exam') {
                showResult(result);
            }
            
            closeActionModal();
            // 移除此处的endRound调用，仅保留关闭结果弹窗时的单次调用
        }

        function showResult(message) {
            const modal = document.getElementById('resultModal');
            const content = document.getElementById('resultContent');
            content.innerHTML = `<p>${message}</p>`;
            modal.classList.add('active');
        }

        function closeResultModal() {
            document.getElementById('resultModal').classList.remove('active');
            // 仅在此处调用endRound，确保所有操作只消耗1回合
            endRound();
        }

        // 所有操作统一消耗 1 回合
        function endRound() {
            gameState.round++;
            updateDisplay();
            
            // 检查压力是否过高
            if (gameState.pressure >= 100) {
                alert('压力过大！游戏结束。');
                resetGame();
            }
        }

        function getKnowledgeName(key) {
            const names = {
                numberTheory: '数论',
                algebra: '代数',
                geometry: '几何',
                operation: '操作',
                reasoning: '推理',
                counting: '计数'
            };
            return names[key];
        }

        function resetGame() {
            document.getElementById('gameModal').classList.remove('active');
            document.getElementById('startModal').classList.add('active');
            // 重置输入框
            document.getElementById('numberTheory').value = 5;
            document.getElementById('algebra').value = 5;
            document.getElementById('geometry').value = 5;
            document.getElementById('operation').value = 5;
            document.getElementById('reasoning').value = 5;
            document.getElementById('counting').value = 5;
            document.getElementById('carefulness').value = 3;
            document.getElementById('mentality').value = 3;
            document.getElementById('speed').value = 3;
            document.getElementById('creativity').value = 3;
            document.getElementById('thinking').value = 3;
            updatePointCounters();
            
            gameState = {
                knowledge: { numberTheory: 0, algebra: 0, geometry: 0, operation: 0, reasoning: 0, counting: 0 },
                talents: { carefulness: 0, mentality: 0, speed: 0, creativity: 0, thinking: 0 },
                pressure: 0,
                round: 1,
                currentAction: null
            };
        }

        // 初始化
        updatePointCounters();
    </script>
</body>
</html>
